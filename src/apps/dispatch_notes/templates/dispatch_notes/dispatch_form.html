{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <h2>{% if form.instance.pk %}Editar{% else %}Crear{% endif %} Nota de Despacho</h2>
    <form method="post" id="dispatch-form">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">Información General</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">{{ form.dispatch_number|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.dispatch_date|as_crispy_field }}</div> 
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.client|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.beneficiary|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.supplier|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.order_number|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-12">{{ form.notes|as_crispy_field }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Información del Conductor y Vehículo</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">{{ form.driver_name|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.driver_id|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-4">{{ form.vehicle_type|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.vehicle_color|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.license_plate|as_crispy_field }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                Artículos de Despacho
                <button type="button" class="btn btn-sm btn-success" id="add-item">➕ Agregar Artículo</button>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                <div id="formset-container">
                    {% for item_form in formset %}
                    <div class="formset-item p-3 border rounded mb-3 bg-light">
                        <div class="d-flex justify-content-end mb-2">
                            <button type="button" class="btn btn-sm btn-danger remove-item">Remover</button>
                        </div>
                        {{ item_form.id }}
                        {{ item_form.DELETE }}
                        <div class="row">
                            <div class="col-md-5 position-relative">
                                {% comment %} CAMPO DE BÚSQUEDA (custom field) {% endcomment %}
                                <label class="form-label requiredField">Producto<span class="asteriskField">*</span></label>
                                {{ item_form.product_search|as_crispy_field }}
                                {% comment %} CAMPO ID (hidden field) {% endcomment %}
                                {{ item_form.product }} 
                                <div class="product-results-container list-group position-absolute w-100 shadow" style="z-index: 100;"></div>
                            </div>
                            <div class="col-md-2">{{ item_form.quantity|as_crispy_field }}</div>
                            <div class="col-md-2">{{ item_form.unit_price|as_crispy_field }}</div>
                            <div class="col-md-3">{{ item_form.product_description|as_crispy_field }}</div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">{{ item_form.brand|as_crispy_field }}</div>
                            <div class="col-md-6">{{ item_form.model|as_crispy_field }}</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn btn-primary btn-lg">Guardar Nota de Despacho</button>
        </div>
    </form>
</div>

<template id="empty-form-template">
    <div class="formset-item p-3 border rounded mb-3 bg-light">
        <div class="d-flex justify-content-end mb-2">
            <button type="button" class="btn btn-sm btn-danger remove-item">Remover</button>
        </div>
        {{ formset.empty_form.id }}
        {{ formset.empty_form.DELETE }}
        <div class="row">
            <div class="col-md-5 position-relative">
                <label class="form-label requiredField">Producto<span class="asteriskField">*</span></label>
                {{ formset.empty_form.product_search|as_crispy_field }}
                {{ formset.empty_form.product }}
                <div class="product-results-container list-group position-absolute w-100 shadow" style="z-index: 100;"></div>
            </div>
            <div class="col-md-2">{{ formset.empty_form.quantity|as_crispy_field }}</div>
            <div class="col-md-2">{{ formset.empty_form.unit_price|as_crispy_field }}</div>
            <div class="col-md-3">{{ formset.empty_form.product_description|as_crispy_field }}</div>
        </div>
        <div class="row">
            <div class="col-md-6">{{ formset.empty_form.brand|as_crispy_field }}</div>
            <div class="col-md-6">{{ formset.empty_form.model|as_crispy_field }}</div>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const formsetContainer = document.getElementById('formset-container');
        const emptyFormTemplate = document.getElementById('empty-form-template');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        let searchTimeout = null;

        // --- Función de utilería para reindexar los formularios ---
        function reindexForms() {
            const forms = formsetContainer.querySelectorAll('.formset-item');
            totalForms.value = forms.length;
            forms.forEach((form, index) => {
                form.querySelectorAll('[name]').forEach(input => {
                    // Reemplaza el índice viejo por el nuevo en el nombre y el ID
                    const newName = input.name.replace(/-\d+-/g, `-${index}-`);
                    input.name = newName;
                    const newId = input.id.replace(/-\d+-/g, `-${index}-`);
                    input.id = newId;
                });
            });
        }

        // --- MANEJO DE FORMSET (Agregar/Remover) ---

        // 1. Botón Agregar Artículo
        document.getElementById('add-item').addEventListener('click', () => {
            const currentTotalForms = parseInt(totalForms.value);
            // Reemplaza el marcador de posición __prefix__ por el índice correcto
            const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, currentTotalForms);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml.trim();
            formsetContainer.appendChild(tempDiv.firstChild);

            totalForms.value = currentTotalForms + 1;
            attachSearchListeners(formsetContainer.lastElementChild);
        });

        // 2. Botón Remover Artículo (Delegación de eventos)
        formsetContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-item')) {
                const formToRemove = e.target.closest('.formset-item');
                if (formToRemove) {
                    // Marcar para eliminación si es un formulario existente (tiene un ID), si no, simplemente remover
                    const deleteInput = formToRemove.querySelector('[name$="-DELETE"]');
                    if (deleteInput) {
                        deleteInput.checked = true;
                        // Ocultar el formulario en lugar de removerlo completamente para mantener la validación del formset
                        formToRemove.style.display = 'none'; 
                    } else {
                        // Si es una fila nueva, se puede eliminar directamente y reindexar
                        formToRemove.remove();
                        reindexForms();
                    }
                }
            }
        });
        
        // --- MANEJO DE BÚSQUEDA DE PRODUCTOS (AJAX) ---
        
        // Función para adjuntar el listener de búsqueda a un formulario
        function attachSearchListeners(formElement) {
            const searchInput = formElement.querySelector('[name$="-product_search"]');
            const hiddenIdInput = formElement.querySelector('[name$="-product"]');
            const descInput = formElement.querySelector('[name$="-product_description"]');
            const priceInput = formElement.querySelector('[name$="-unit_price"]');
            const resultsContainer = formElement.querySelector('.product-results-container');
            
            if (!searchInput) return;

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Limpiar el temporizador anterior
                clearTimeout(searchTimeout);
                
                if (query.length < 3) {
                    resultsContainer.innerHTML = '';
                    return;
                }
                
                // Establecer un nuevo temporizador
                searchTimeout = setTimeout(() => {
                    // Realizar la petición AJAX
                    fetch(`{% url 'dispatch_notes:product_search_api' %}?q=${query}`)
                        .then(response => response.json())
                        .then(data => {
                            resultsContainer.innerHTML = ''; // Limpiar resultados anteriores
                            
                            if (data.length > 0) {
                                data.forEach(product => {
                                    const item = document.createElement('a');
                                    item.href = '#';
                                    item.classList.add('list-group-item', 'list-group-item-action');
                                    item.textContent = `${product.code} - ${product.description}`;
                                    
                                    item.addEventListener('click', (event) => {
                                        event.preventDefault();
                                        
                                        // Rellenar campos
                                        searchInput.value = product.code; // Rellenar búsqueda con el código
                                        hiddenIdInput.value = product.id; // Asignar el ID al campo oculto
                                        descInput.value = product.description; // Rellenar descripción del ítem
                                        priceInput.value = product.unit_price || '0.00'; 
                                        
                                        // Limpiar resultados
                                        resultsContainer.innerHTML = '';
                                    });
                                    
                                    resultsContainer.appendChild(item);
                                });
                            } else {
                                resultsContainer.innerHTML = '<div class="list-group-item">No se encontraron productos.</div>';
                            }
                        })
                        .catch(error => {
                            console.error('Error en la búsqueda de productos:', error);
                            resultsContainer.innerHTML = '<div class="list-group-item list-group-item-danger">Error al buscar.</div>';
                        });
                }, 300); // 300ms de retraso
            });
            
            // Limpiar resultados si se pierde el foco
            searchInput.addEventListener('blur', () => {
                // Pequeño retraso para permitir el clic en un resultado antes de que se oculte
                setTimeout(() => {
                    resultsContainer.innerHTML = '';
                }, 200);
            });

            // Función para re-mostrar resultados si el input está enfocado y tiene texto
            searchInput.addEventListener('focus', (e) => {
                if (e.target.value.trim().length >= 3) {
                    // Simular un evento de 'input' para disparar la búsqueda de nuevo
                    e.target.dispatchEvent(new Event('input'));
                }
            });
        }

        // Adjuntar listeners a los formularios existentes al cargar la página
        formsetContainer.querySelectorAll('.formset-item').forEach(attachSearchListeners);
        
    });
</script>
{% endblock %}