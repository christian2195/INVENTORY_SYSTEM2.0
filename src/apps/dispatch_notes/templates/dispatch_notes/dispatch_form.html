{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block content %}
<div class="container mt-4">
    <h2>{% if form.instance.pk %}Editar{% else %}Crear{% endif %} Nota de Despacho</h2>
    <form method="post" id="dispatch-form">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">Información General</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">{{ form.dispatch_number|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.dispatch_date|as_crispy_field }}</div> 
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.client|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.beneficiary|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.supplier|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.order_number|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-12">{{ form.notes|as_crispy_field }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Información del Conductor y Vehículo</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">{{ form.driver_name|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.driver_id|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-4">{{ form.vehicle_type|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.vehicle_color|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.license_plate|as_crispy_field }}</div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Artículos de Despacho</span>
                <button type="button" class="btn btn-sm btn-success" id="add-item">
                    <i class="fas fa-plus me-1"></i> Agregar Artículo
                </button>
            </div>
            <div class="card-body">
                {{ formset.management_form }}
                <div id="formset-container">
                    {% for item_form in formset %}
                    <div class="formset-item p-3 border rounded mb-3 bg-light">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 text-muted">Artículo #{{ forloop.counter }}</h6>
                            <button type="button" class="btn btn-sm btn-danger remove-item">
                                <i class="fas fa-times me-1"></i> Remover
                            </button>
                        </div>
                        {{ item_form.id }}
                        {{ item_form.DELETE }}
                        <div class="row g-3">
                            <!-- Columna de búsqueda de producto -->
                            <div class="col-md-4 position-relative">
                                <label class="form-label requiredField">
                                    Producto<span class="asteriskField">*</span>
                                </label>
                                {{ item_form.product_search }}
                                {{ item_form.product }}
                                <div class="product-results-container list-group position-absolute w-100 shadow" style="z-index: 1050; display: none;"></div>
                                {% if item_form.product_search.errors %}
                                <div class="text-danger small mt-1">
                                    {{ item_form.product_search.errors }}
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- Columna de cantidad -->
                            <div class="col-md-2">
                                {{ item_form.quantity|as_crispy_field }}
                            </div>
                            
                            <!-- Columna de precio unitario -->
                            <div class="col-md-2">
                                {{ item_form.unit_price|as_crispy_field }}
                            </div>
                            
                            <!-- Columna de descripción -->
                            <div class="col-md-2">
                                {{ item_form.product_description|as_crispy_field }}
                            </div>
                            
                            <!-- Columna de stock disponible -->
                            <div class="col-md-2">
                                {{ item_form.current_stock|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <!-- Columna de marca -->
                            <div class="col-md-6">
                                {{ item_form.brand|as_crispy_field }}
                            </div>
                            
                            <!-- Columna de modelo -->
                            <div class="col-md-6">
                                {{ item_form.model|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- Alerta de stock insuficiente -->
                        <div class="stock-alert mt-2" style="display: none;">
                            <div class="alert alert-danger py-2 mb-0">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <span class="stock-message"></span>
                            </div>
                        </div>
                        
                        <!-- Mostrar errores del formulario -->
                        {% if item_form.errors %}
                        <div class="alert alert-danger mt-2">
                            {% for field, errors in item_form.errors.items %}
                                {% if field != '__all__' %}
                                    {% for error in errors %}
                                        <div class="small">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="text-end">
            <a href="{% url 'dispatch_notes:list' %}" class="btn btn-secondary me-2">
                <i class="fas fa-times me-1"></i> Cancelar
            </a>
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-save me-1"></i> Guardar Nota de Despacho
            </button>
        </div>
    </form>
</div>

<template id="empty-form-template">
    <div class="formset-item p-3 border rounded mb-3 bg-light">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 text-muted">Artículo Nuevo</h6>
            <button type="button" class="btn btn-sm btn-danger remove-item">
                <i class="fas fa-times me-1"></i> Remover
            </button>
        </div>
        {{ formset.empty_form.id }}
        {{ formset.empty_form.DELETE }}
        <div class="row g-3">
            <!-- Columna de búsqueda de producto -->
            <div class="col-md-4 position-relative">
                <label class="form-label requiredField">
                    Producto<span class="asteriskField">*</span>
                </label>
                {{ formset.empty_form.product_search }}
                {{ formset.empty_form.product }}
                <div class="product-results-container list-group position-absolute w-100 shadow" style="z-index: 1050; display: none;"></div>
            </div>
            
            <!-- Columna de cantidad -->
            <div class="col-md-2">
                {{ formset.empty_form.quantity|as_crispy_field }}
            </div>
            
            <!-- Columna de precio unitario -->
            <div class="col-md-2">
                {{ formset.empty_form.unit_price|as_crispy_field }}
            </div>
            
            <!-- Columna de descripción -->
            <div class="col-md-2">
                {{ formset.empty_form.product_description|as_crispy_field }}
            </div>
            
            <!-- Columna de stock disponible -->
            <div class="col-md-2">
                {{ formset.empty_form.current_stock|as_crispy_field }}
            </div>
        </div>
        
        <div class="row g-3 mt-2">
            <!-- Columna de marca -->
            <div class="col-md-6">
                {{ formset.empty_form.brand|as_crispy_field }}
            </div>
            
            <!-- Columna de modelo -->
            <div class="col-md-6">
                {{ formset.empty_form.model|as_crispy_field }}
            </div>
        </div>
        
        <!-- Alerta de stock insuficiente -->
        <div class="stock-alert mt-2" style="display: none;">
            <div class="alert alert-danger py-2 mb-0">
                <i class="fas fa-exclamation-triangle me-1"></i>
                <span class="stock-message"></span>
            </div>
        </div>
    </div>
</template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const formsetContainer = document.getElementById('formset-container');
        const emptyFormTemplate = document.getElementById('empty-form-template');
        const totalForms = document.getElementById('id_items-TOTAL_FORMS');
        let searchTimeout = null;

        // --- Función de utilería para reindexar los formularios ---
        function reindexForms() {
            const forms = formsetContainer.querySelectorAll('.formset-item');
            totalForms.value = forms.length;
            forms.forEach((form, index) => {
                form.querySelectorAll('[name]').forEach(input => {
                    // Reemplaza el índice viejo por el nuevo en el nombre y el ID
                    const newName = input.name.replace(/-\d+-/g, `-${index}-`);
                    input.name = newName;
                    const newId = input.id.replace(/-\d+-/g, `-${index}-`);
                    input.id = newId;
                });
                
                // Actualizar el número del artículo
                const title = form.querySelector('h6');
                if (title) {
                    title.textContent = `Artículo #${index + 1}`;
                }
            });
        }

        // --- NUEVA FUNCIÓN: Validar stock en tiempo real ---
        function validateStock(formElement) {
            const productId = formElement.querySelector('[name$="-product"]').value;
            const quantityInput = formElement.querySelector('[name$="-quantity"]');
            const stockDisplay = formElement.querySelector('[name$="-current_stock"]');
            const stockAlert = formElement.querySelector('.stock-alert');
            const stockMessage = formElement.querySelector('.stock-message');
            
            if (!productId || !quantityInput.value) {
                if (stockAlert) stockAlert.style.display = 'none';
                if (quantityInput) quantityInput.classList.remove('is-invalid');
                return;
            }
            
            const quantity = parseInt(quantityInput.value) || 0;
            
            // Obtener información del producto desde la API
            fetch(`{% url 'dispatch_notes:product_search_api' %}?id=${productId}`)
                .then(response => response.json())
                .then(products => {
                    if (products.length > 0) {
                        const product = products[0];
                        const currentStock = product.current_stock || 0;
                        
                        // Actualizar display de stock
                        if (stockDisplay) {
                            stockDisplay.value = `${currentStock} unidades`;
                            
                            // Cambiar color según stock
                            if (currentStock === 0) {
                                stockDisplay.classList.add('text-danger');
                                stockDisplay.classList.remove('text-success');
                            } else if (currentStock < 10) {
                                stockDisplay.classList.add('text-warning');
                                stockDisplay.classList.remove('text-success');
                            } else {
                                stockDisplay.classList.add('text-success');
                                stockDisplay.classList.remove('text-danger', 'text-warning');
                            }
                        }
                        
                        // Mostrar alerta si el stock es insuficiente
                        if (quantity > currentStock) {
                            if (stockMessage) {
                                stockMessage.textContent = `Stock insuficiente. Disponible: ${currentStock}, Solicitado: ${quantity}`;
                            }
                            if (stockAlert) {
                                stockAlert.style.display = 'block';
                            }
                            if (quantityInput) {
                                quantityInput.classList.add('is-invalid');
                            }
                        } else {
                            if (stockAlert) stockAlert.style.display = 'none';
                            if (quantityInput) quantityInput.classList.remove('is-invalid');
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al validar stock:', error);
                });
        }

        // --- MANEJO DE FORMSET (Agregar/Remover) ---

        // 1. Botón Agregar Artículo
        document.getElementById('add-item').addEventListener('click', () => {
            const currentTotalForms = parseInt(totalForms.value);
            // Reemplaza el marcador de posición __prefix__ por el índice correcto
            const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, currentTotalForms);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newFormHtml.trim();
            const newForm = tempDiv.firstChild;
            
            formsetContainer.appendChild(newForm);
            totalForms.value = currentTotalForms + 1;
            
            // Reindexar todos los formularios
            reindexForms();
            
            // Adjuntar listeners al nuevo formulario
            attachSearchListeners(newForm);
        });

        // 2. Botón Remover Artículo (Delegación de eventos)
        formsetContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('remove-item') || e.target.closest('.remove-item')) {
                const button = e.target.classList.contains('remove-item') ? e.target : e.target.closest('.remove-item');
                const formToRemove = button.closest('.formset-item');
                if (formToRemove) {
                    const deleteInput = formToRemove.querySelector('[name$="-DELETE"]');
                    if (deleteInput) {
                        deleteInput.checked = true;
                        formToRemove.style.display = 'none'; 
                    } else {
                        formToRemove.remove();
                        reindexForms();
                    }
                }
            }
        });
        
        // --- MANEJO DE BÚSQUEDA DE PRODUCTOS (AJAX) MEJORADO ---
        
        function attachSearchListeners(formElement) {
            const searchInput = formElement.querySelector('[name$="-product_search"]');
            const hiddenIdInput = formElement.querySelector('[name$="-product"]');
            const descInput = formElement.querySelector('[name$="-product_description"]');
            const priceInput = formElement.querySelector('[name$="-unit_price"]');
            const stockDisplay = formElement.querySelector('[name$="-current_stock"]');
            const quantityInput = formElement.querySelector('[name$="-quantity"]');
            const resultsContainer = formElement.querySelector('.product-results-container');
            
            if (!searchInput) return;

            // Función para mostrar/ocultar resultados
            function showResults() {
                if (resultsContainer) resultsContainer.style.display = 'block';
            }
            
            function hideResults() {
                if (resultsContainer) resultsContainer.style.display = 'none';
            }

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                clearTimeout(searchTimeout);
                
                if (query.length < 2) {
                    hideResults();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    fetch(`{% url 'dispatch_notes:product_search_api' %}?q=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            if (!resultsContainer) return;
                            
                            resultsContainer.innerHTML = '';
                            
                            if (data.length > 0) {
                                data.forEach(product => {
                                    const item = document.createElement('a');
                                    item.href = '#';
                                    item.classList.add('list-group-item', 'list-group-item-action');
                                    
                                    // Mostrar stock en los resultados
                                    const stockInfo = product.current_stock !== undefined ? 
                                        ` (Stock: ${product.current_stock})` : '';
                                    const stockClass = product.current_stock === 0 ? 'text-danger' : 
                                                     product.current_stock < 10 ? 'text-warning' : 'text-success';
                                    
                                    item.innerHTML = `
                                        <div>
                                            <strong>${product.product_code}</strong> - ${product.description}
                                            <br>
                                            <small class="${stockClass}">
                                                Stock: ${product.current_stock || 0} | Precio: Bs. ${product.unit_price || '0.00'}
                                            </small>
                                        </div>
                                    `;
                                    
                                    item.addEventListener('click', (event) => {
                                        event.preventDefault();
                                        
                                        // Rellenar campos
                                        searchInput.value = product.product_code;
                                        hiddenIdInput.value = product.id;
                                        if (descInput) descInput.value = product.description;
                                        if (priceInput) priceInput.value = product.unit_price || '0.00';
                                        
                                        // Actualizar stock
                                        if (stockDisplay) {
                                            stockDisplay.value = `${product.current_stock || 0} unidades`;
                                        }
                                        
                                        // Validar stock automáticamente si hay cantidad
                                        if (quantityInput && quantityInput.value) {
                                            validateStock(formElement);
                                        }
                                        
                                        hideResults();
                                    });
                                    
                                    resultsContainer.appendChild(item);
                                });
                                showResults();
                            } else {
                                resultsContainer.innerHTML = '<div class="list-group-item text-muted">No se encontraron productos.</div>';
                                showResults();
                            }
                        })
                        .catch(error => {
                            console.error('Error en la búsqueda de productos:', error);
                            if (resultsContainer) {
                                resultsContainer.innerHTML = '<div class="list-group-item list-group-item-danger">Error al buscar productos.</div>';
                                showResults();
                            }
                        });
                }, 300);
            });
            
            // NUEVO: Validar stock cuando cambia la cantidad
            if (quantityInput) {
                quantityInput.addEventListener('input', () => {
                    validateStock(formElement);
                });
                
                quantityInput.addEventListener('blur', () => {
                    validateStock(formElement);
                });
            }
            
            // Manejar foco y blur para resultados
            searchInput.addEventListener('focus', (e) => {
                if (e.target.value.trim().length >= 2) {
                    e.target.dispatchEvent(new Event('input'));
                }
            });
            
            // Ocultar resultados al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!formElement.contains(e.target)) {
                    hideResults();
                }
            });
        }

        // Adjuntar listeners a los formularios existentes al cargar la página
        formsetContainer.querySelectorAll('.formset-item').forEach(attachSearchListeners);
        
        // Validar stock inicial para formularios existentes
        formsetContainer.querySelectorAll('.formset-item').forEach(formElement => {
            const productId = formElement.querySelector('[name$="-product"]').value;
            if (productId) {
                validateStock(formElement);
            }
        });
        
    });
</script>

<style>
    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
    .stock-alert .alert {
        margin-bottom: 0;
        font-size: 0.875rem;
    }
    .product-results-container {
        max-height: 200px;
        overflow-y: auto;
    }
    .formset-item {
        transition: all 0.3s ease;
    }
    .formset-item:hover {
        border-color: #0d6efd !important;
    }
    .text-danger {
        color: #dc3545 !important;
    }
    .text-warning {
        color: #ffc107 !important;
    }
    .text-success {
        color: #198754 !important;
    }
</style>
{% endblock %}